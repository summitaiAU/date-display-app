name: Expo Deploy
on:
  push:
    branches:
      - main
jobs:
  deploy:
    name: Deploy to Expo
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: npm

      - name: Create new app.json without project ID
        run: |
          echo '{
            "expo": {
              "name": "date-display-app",
              "slug": "date-display-app",
              "owner": "${{ secrets.EXPO_USERNAME }}",
              "version": "1.0.0",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "userInterfaceStyle": "light",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#ffffff"
              },
              "assetBundlePatterns": [
                "**/*"
              ],
              "ios": {
                "supportsTablet": true,
                "bundleIdentifier": "com.datedisplayapp"
              },
              "android": {
                "adaptiveIcon": {
                  "foregroundImage": "./assets/adaptive-icon.png",
                  "backgroundColor": "#ffffff"
                },
                "package": "com.datedisplayapp"
              },
              "web": {
                "favicon": "./assets/favicon.png"
              },
              "runtimeVersion": {
                "policy": "sdkVersion"
              }
            }
          }' > app.json
          
          # Show the updated file
          cat app.json

      - name: Update package.json with compatible React version
        run: |
          cat > package.json << 'EOL'
          {
            "name": "date-display-app",
            "version": "1.0.0",
            "main": "node_modules/expo/AppEntry.js",
            "scripts": {
              "start": "expo start",
              "android": "expo start --android",
              "ios": "expo start --ios",
              "web": "expo start --web"
            },
            "dependencies": {
              "expo": "~52.0.0",
              "expo-status-bar": "~1.11.1",
              "expo-updates": "~0.24.8",
              "react": "18.2.0",
              "react-native": "0.73.2",
              "react-native-safe-area-context": "4.8.2",
              "react-dom": "18.2.0",
              "react-native-web": "~0.19.6",
              "expo-splash-screen": "~0.26.4"
            },
            "devDependencies": {
              "@babel/core": "^7.20.0",
              "@babel/plugin-transform-export-namespace-from": "^7.22.11",
              "babel-preset-expo": "~10.0.0"
            },
            "private": true
          }
          EOL
          
          # Show the updated file
          cat package.json

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Install Expo CLI
        run: npm install -g expo-cli

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Login to Expo
        run: |
          CI=1 npx expo login -u ${{ secrets.EXPO_USERNAME }} -p ${{ secrets.EXPO_PASSWORD }}
          
      - name: Initialize EAS
        run: |
          npx eas init --non-interactive --force
          
      - name: Check Environment
        run: |
          echo "Node version: $(node -v)"
          echo "npm version: $(npm -v)"
          echo "EAS CLI version: $(eas --version || echo 'not found')"
          echo "Expo CLI version: $(expo --version || echo 'not found')"
          echo "Current directory: $(pwd)"
          echo "Current app.json content:"
          cat app.json
          
      - name: Publish update
        run: |
          npx eas update --branch main --message "GitHub Actions Deploy $(date +%s)" --non-interactive || 
          (echo "::error::EAS update failed" && exit 1)
